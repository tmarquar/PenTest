<?php // installed_programs.php
class Installed_Programs
{
    // connection shiz
    private $conn;
    private $table_name = "installed_programs";
    
    // object properties
    public $business_id;
    public $machine_id;
    public $name;
    public $version;
    public $install_date;
    
    // constructor using db connection
    public function __construct($db)
    {
        $this->conn         = $db;
    }
    
    // read all the programs
    function read()
    {
        $this->business_id  = htmlspecialchars(strip_tags($this->business_id));
        $this->machine_id   = htmlspecialchars(strip_tags($this->machine_id));
        
        // select all the programs from a machine
        $query  = "SELECT Name, Version, Install_Date
                    FROM ". $this->table_name ."
                    WHERE
                        Business_ID = '". $this->business_id ."'
                            AND
                        Machine_ID = '". $this->machine_id ."'
                    ORDER BY Name";
        
        // prepare that statement
        $stmt   = $this->conn->prepare($query);
        
        $stmt->execute();
        
        return $stmt;
    }
    
    // pull one
    function pull_one()
    {
        $query  = "SELECT Name, Version, Install_Date
                    FROM ". $this->table_name ."
                    WHERE Business_ID = '". $this->business_id ."' AND Machine_ID = '". $this->machine_id ."'
                    ORDER BY Name";
                    
        // prepare that statement
        $stmt   = $this->conn->prepare($query);
        
        $stmt->execute();
        
        $row    = $stmt->fetch(PDO::FETCH_ASSOC);
        // Set local variables accordingly
        $this->name         = $row['Name'];
        $this->version      = $row['Version'];
        $this->install_date = $row['Install_Date'];
    }
    
    // create a new program entry
    function create()
    {
        $query  = "INSERT INTO ". $this->table_name ."
                    (
                        Business_ID,
                        Machine_ID,
                        Name,
                        Version,
                        Install_Date
                    )
                    VALUES
                    (
                        :business_id,
                        :machine_id,
                        :name,
                        :version,
                        :install_date
                    )";
        // prepare that statement
        $stmt   = $this->conn->prepare($query);
        
        // sanitize
        $this->business_id  = htmlspecialchars(strip_tags($this->business_id));
        $this->machine_id   = htmlspecialchars(strip_tags($this->machine_id));
        $this->name         = htmlspecialchars(strip_tags($this->name));
        $this->version      = htmlspecialchars(strip_tags($this->version));
        $this->install_date = htmlspecialchars(strip_tags($this->install_date));
        
        // bind those clean parameters into the statement
        $stmt->bindParam(':business_id',        $this->business_id);
        $stmt->bindParam(':machine_id',         $this->machine_id);
        $stmt->bindParam(':name',               $this->name);
        $stmt->bindParam(':version',            $this->version);
        $stmt->bindParam(':install_date',       $this->install_date);
        
        // execute it, tell requester how that went
        if ($stmt->execute())
        {
            return true;
        }
        //mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);
        return false;
    }
    
    //update
    function update()
    {
        // the update query
        $query  = "UPDATE ". $this->table_name ."
                    SET
                        Name        =:name,
                        Version     =:version,
                        Install_Date=:install_date
                    WHERE
                        Business_ID =:business_id
                            AND
                        Machine_ID  =:machine_id";
                        
        // statement needs some preparing
        $stmt   = $this->conn->prepare($query);
        
        // sanitize that shiz
        $this->business_id  = htmlspecialchars(strip_tags($this->business_id));
        $this->machine_id   = htmlspecialchars(strip_tags($this->machine_id));
        $this->name         = htmlspecialchars(strip_tags($this->name));
        $this->version      = htmlspecialchars(strip_tags($this->version));
        $this->install_date = htmlspecialchars(strip_tags($this->install_date));
        
        // put it in!
        $stmt->bindParam(':business_id',    $this->business_id);
        $stmt->bindParam(':machine_id',     $this->machine_id);
        $stmt->bindParam(':name',           $this->name);
        $stmt->bindParam(':version',        $this->version);
        $stmt->bindParam(':install_date',   $this->install_date); 
        $stmt->bindParam(':business_id',    $this->business_id);
        $stmt->bindParam(':machine_id',     $this->machine_id);
        
        // execute it
        if ($stmt->execute())
        {
            return true;
        }
        return false;
    }
}
?>